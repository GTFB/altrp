# ü§ñ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä Telegram –ë–æ—Ç–æ–≤

**–ú–æ—â–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Telegram –±–æ—Ç–æ–≤ —Å –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π –Ω–∞ Cloudflare Workers.**

–≠—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –±–æ—Ç, –∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π **–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –±–æ—Ç–æ–≤** - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–±–æ—Ä—â–∏–∫–∞–º –±–æ—Ç–æ–≤ –ª–µ–≥–∫–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –±–æ—Ç–æ–≤ –±–µ–∑ –≥–ª—É–±–æ–∫–∏—Ö –∑–Ω–∞–Ω–∏–π –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è.

## üéØ –ß—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ?

**–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –±–æ—Ç–æ–≤** - —ç—Ç–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç:

- **–ì–æ—Ç–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É** –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–æ—Ç–æ–≤
- **–ú–æ–¥—É–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É** —Ñ–ª–æ—É (–¥–∏–∞–ª–æ–≥–æ–≤)
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é** –∫–æ–¥–∞
- **–ì–æ—Ç–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã** (–∫–æ–º–∞–Ω–¥—ã, —Ö—ç–Ω–¥–ª–µ—Ä—ã, —Ö—Ä–∞–Ω–∏–ª–∏—â–∞)
- **–ü—Ä–æ—Å—Ç–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ** –≤ Cloudflare

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞

### üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
/apps/bot
‚îú‚îÄ‚îÄ /src
‚îÇ   ‚îú‚îÄ‚îÄ /core                         # –Ø–¥—Ä–æ —Å–∏—Å—Ç–µ–º—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ flow-engine.ts            # –î–≤–∏–∂–æ–∫ —Ñ–ª–æ—É
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ message-service.ts        # –°–µ—Ä–≤–∏—Å —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user-context.ts           # –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ i18n.ts                   # –ò–Ω—Ç–µ—Ä–Ω–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ /config                       # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —Å–±–æ—Ä—â–∏–∫–æ–º)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ /flows                    # –§–ª–æ—É –±–æ—Ç–∞ (–∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts              # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ start_registration.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ onboarding.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...                   # –î—Ä—É–≥–∏–µ —Ñ–ª–æ—É
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ commands.ts               # –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ callbacks.ts              # Callback –∫–Ω–æ–ø–∫–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ handlers.ts               # –•—ç–Ω–¥–ª–µ—Ä—ã –ª–æ–≥–∏–∫–∏
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ /worker                       # –°–ª–æ–π —Ä–∞–±–æ—Ç—ã —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bot.ts                    # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ d1-storage-service.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ kv-storage-service.ts
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ /scripts                      # –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å–±–æ—Ä—â–∏–∫–∞
‚îÇ       ‚îî‚îÄ‚îÄ generate-flows-index.js   # –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–ª–æ—É
‚îÇ
‚îú‚îÄ‚îÄ wrangler.toml                     # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Cloudflare
‚îú‚îÄ‚îÄ DEPLOYMENT.md                     # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é
‚îî‚îÄ‚îÄ README.md                         # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

## üé® –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä

### 1. **–ú–æ–¥—É–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ñ–ª–æ—É**

–°–±–æ—Ä—â–∏–∫ —Å–æ–∑–¥–∞–µ—Ç —Ñ–ª–æ—É –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö:

```typescript
// apps/bot/src/config/flows/onboarding.ts
export const onboardingFlow: BotFlow = {
  name: 'onboarding',
  description: '–ü—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏',
  steps: [
    {
      type: 'message',
      id: 'welcome',
      messageKey: 'welcome_message',
      keyboardKey: 'start_button'
    },
    {
      type: 'wait_input',
      id: 'ask_name',
      prompt: 'enter_name',
      saveToVariable: 'user.name'
    }
    // ... –¥—Ä—É–≥–∏–µ —à–∞–≥–∏
  ]
};
```

### 2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è**

–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- **–ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ —Ñ–ª–æ—É** –≤ –ø–∞–ø–∫–µ `flows/`
- **–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç `index.ts`** —Å –∏–º–ø–æ—Ä—Ç–∞–º–∏
- **–ü–æ–¥–∫–ª—é—á–∞–µ—Ç —Ñ–ª–æ—É** –∫ –¥–≤–∏–∂–∫—É
- **–û–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é** –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Ñ–ª–æ—É

```bash
npm run generate-flows-index
# ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç –∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç –≤—Å–µ —Ñ–ª–æ—É
```

### 3. **–ì–æ—Ç–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**

#### –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ (`commands.ts`)
```typescript
export const commands = [
  { name: "/start", handlerName: "handleStartCommand" },
  { name: "/menu", handlerName: "handleMenuCommand" },
  { name: "/help", handlerName: "handleHelpCommand" }
];
```

#### Callback –∫–Ω–æ–ø–∫–∏ (`callbacks.ts`)
```typescript
export const keyboards = {
  main_menu: {
    inline_keyboard: [[
      { text: "üìÑ –°–æ–∑–¥–∞—Ç—å —Å—á–µ—Ç", callback_data: "create_invoice" },
      { text: "üìä –û—Ç—á–µ—Ç—ã", callback_data: "reports" }
    ]]
  }
};
```

#### –•—ç–Ω–¥–ª–µ—Ä—ã –ª–æ–≥–∏–∫–∏ (`handlers.ts`)
```typescript
export const createCustomHandlers = (worker: BotInterface) => ({
  handleStartCommand: async (message, bot) => {
    // –õ–æ–≥–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
  },
  createInvoice: async (telegramId, contextManager) => {
    // –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á–µ—Ç–∞
  }
});
```

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —Å–±–æ—Ä—â–∏–∫–∞

### ‚úÖ **–ü—Ä–æ—Å—Ç–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–ª–æ—É**
1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `new_flow.ts` –≤ –ø–∞–ø–∫–µ `flows/`
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å `npm run generate-flows-index`
3. –§–ª–æ—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è!

### ‚úÖ **–ì–æ—Ç–æ–≤—ã–µ —Ç–∏–ø—ã —à–∞–≥–æ–≤**
- `message` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
- `wait_input` - –æ–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞
- `handler` - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏
- `flow` - –ø–µ—Ä–µ—Ö–æ–¥ –∫ –¥—Ä—É–≥–æ–º—É —Ñ–ª–æ—É
- `dynamic` - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
- `condition` - —É—Å–ª–æ–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã

### ‚úÖ **–°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö**
```typescript
// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
await contextManager.setVariable(telegramId, 'user.name', '–ò–≤–∞–Ω');
await contextManager.setVariable(telegramId, 'company.pib', '123456789');

// –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
const userName = await contextManager.getVariable(telegramId, 'user.name');
```

### ‚úÖ **–ò–Ω—Ç–µ—Ä–Ω–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è**
```typescript
// –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —è–∑—ã–∫–æ–≤
const message = await i18nService.getMessage('welcome_message', 'ru');
```

### ‚úÖ **–•—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–∞–Ω–Ω—ã—Ö**
- **D1 Database** - –æ—Å–Ω–æ–≤–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **KV Storage** - –∫—ç—à –∏ —Å–µ—Å—Å–∏–∏
- **R2 Storage** - —Ñ–∞–π–ª—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã

## üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **Runtime**: Cloudflare Workers (V8 Isolates)
- **Database**: SQLite (Cloudflare D1)
- **Cache**: Cloudflare KV
- **Files**: Cloudflare R2
- **Language**: TypeScript
- **Build**: Wrangler CLI

## üìã –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è —Å–±–æ—Ä—â–∏–∫–∞

### 1. **–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞**
```bash
git clone <repository>
cd apps/bot
npm install
```

### 2. **–°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ —Ñ–ª–æ—É**
```bash
# –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª flows/my_flow.ts
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—é
npm run generate-flows-index
```

### 3. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã**
```typescript
// –í commands.ts
{ name: "/my_command", handlerName: "handleMyCommand" }

// –í handlers.ts
handleMyCommand: async (message, bot) => {
  // –í–∞—à–∞ –ª–æ–≥–∏–∫–∞
}
```

### 4. **–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ**
```bash
npm run deploy
```

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞

### –î–ª—è —Å–±–æ—Ä—â–∏–∫–∞ –±–æ—Ç–æ–≤:
- ‚úÖ **–ë—ã—Å—Ç—Ä–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞** - –≥–æ—Ç–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- ‚úÖ **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ **–ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è** - –º–∏–Ω–∏–º—É–º —Ä—É—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã
- ‚úÖ **–ì–æ—Ç–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ** - –æ–¥–∏–Ω –∫–ª–∏–∫
- ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ—Ç–æ–≤:
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - Cloudflare –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ‚úÖ **–°–∫–æ—Ä–æ—Å—Ç—å** - –≥–ª–æ–±–∞–ª—å–Ω–∞—è —Å–µ—Ç—å
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –∏–∑–æ–ª—è—Ü–∏—è –∏ –∑–∞—â–∏—Ç–∞
- ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **[DEPLOYMENT.md](./DEPLOYMENT.md)** - –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é
- **[–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ñ–ª–æ—É](./src/core/flow-types.ts)** - –¢–∏–ø—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
- **[–ü—Ä–∏–º–µ—Ä—ã —Ñ–ª–æ—É](./src/config/flows/)** - –ì–æ—Ç–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã

## ü§ù –í–∫–ª–∞–¥ –≤ —Ä–∞–∑–≤–∏—Ç–∏–µ

–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –æ—Ç–∫—Ä—ã—Ç –¥–ª—è —É–ª—É—á—à–µ–Ω–∏–π! –í—ã –º–æ–∂–µ—Ç–µ:
- –î–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã —à–∞–≥–æ–≤
- –°–æ–∑–¥–∞–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–µ —Ñ–ª–æ—É-—à–∞–±–ª–æ–Ω—ã
- –£–ª—É—á—à–∞—Ç—å –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—é
- –†–∞—Å—à–∏—Ä—è—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

---

**üéâ –°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Å–≤–æ–∏—Ö –±–æ—Ç–æ–≤ –ª–µ–≥–∫–æ –∏ –±—ã—Å—Ç—Ä–æ!**